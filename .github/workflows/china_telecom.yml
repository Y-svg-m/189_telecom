name: 中国电信每日任务

on:
  # 每天在北京时间 7:30 运行一次 (UTC: 23:30)
  schedule:
    - cron: '30 23 * * *' 
  # 允许手动触发
  workflow_dispatch:

jobs:
  run-script:
    runs-on: ubuntu-latest
    
    # 引用您在 Settings -> Environments 中设置的名称，这里是 'user'
    environment: user 
    
    # 定义环境变量。这里的变量值会自动从 'user' Environment 的 Secrets/Variables 中获取。
    env:
      # 账号变量：从 Environment Secrets/Variables 中读取 CHINA_TELECOM_ACCOUNTS
      chinaTelecomAccount: ${{ secrets.CHINA_TELECOM_ACCOUNTS }}
      # 可选：口令变量
      dx_kl: ${{ secrets.DX_KL }} 
      # 可选：微信推送 appToken
      apptoken: ${{ secrets.WXPUSHER_APPTOKEN }}
      # 可选：微信推送 UIDs
      WXPUSHER_UIDS: ${{ secrets.WXPUSHER_UIDS }}

    steps:
    - name: 检出代码 (Checkout repository)
      uses: actions/checkout@v4

    - name: 设置 Python 环境 (Set up Python)
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: 安装依赖 (Install dependencies)
      run: |
        python -m pip install --upgrade pip
        # 安装所有必需的库：requests, aiohttp, httpx, pycryptodome, pandas, tabulate, tenacity
        pip install requests aiohttp httpx pycryptodome pandas tabulate tenacity

    - name: 运行中国电信脚本 (Run China Telecom Script)
      run: |
        # 1. 直接运行脚本，它会自动读取上面 env 中设置的环境变量。
        #    无需 sed 命令注入。
        python china_telecom_task.py
